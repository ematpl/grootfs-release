# abort script on any command that exits with a non zero value
set -e

export PACKAGES=/var/vcap/packages
export PATH=$PACKAGES/grootfs-build-tools/bin:$PATH
export PREFIX=$PACKAGES/grootfs-build-tools

tar xvzf shadow/shadow-4.3.1.tar.gz

(
  cd shadow-4.3.1
  patch src/newuidmap.c < ../shadow/src.newuidmap-skip-range-verification.patch
  patch src/newgidmap.c < ../shadow/src.newgidmap-skip-range-verification.patch

  autoreconf -v -f --install || exit 1
  ./configure \
        CFLAGS="-O2 -Wall" \
        --enable-man=no \
        --disable-shared \
        --without-libpam \
        --with-selinux=no \
        "$@"

  sed -i 's/SUBDIRS = po man libmisc lib src/SUBDIRS = po libmisc lib src/' Makefile
  make
  make install prefix=$BOSH_INSTALL_TARGET
)
